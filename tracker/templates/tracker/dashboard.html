<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Expense Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      body { background:#f5f7fb; }
      .card-total {
        background: linear-gradient(90deg,#4f46e5,#06b6d4);
        color: white;
      }
      .card-budget {
        background: linear-gradient(90deg,#16a34a,#22c55e);
        color: white;
      }
      .card-warning {
        background: linear-gradient(90deg,#dc2626,#f97316);
        color: white;
      }
      .card-category {
        background: linear-gradient(135deg,#f59e0b,#f97316);
        color: white;
      }
      .small-muted { font-size:0.9rem; color:#6b7280; }
      .table-wrap { max-height:60vh; overflow:auto; }
      .chart-container { position: relative; height: 300px; margin-bottom: 2rem; }
      .chart-wrapper { background: white; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    </style>
  </head>

  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand bg-white shadow-sm mb-4">
      <div class="container">
        <a class="navbar-brand fw-bold" href="#">Expense Tracker</a>
        <div class="d-flex align-items-center">
          <span class="me-3 small-muted">Signed in as {{ user.username }}</span>
          <a class="btn btn-outline-primary btn-sm" href="{% url 'add_expense' %}">Add Expense</a>
        </div>
      </div>
    </nav>
    

    <div class="container">
      <!-- TOP CARDS -->
      <div class="row g-3 mb-4">

        <!-- Total Expense -->
        <div class="col-md-4">
          <div class="card card-total shadow-sm p-3">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="small-muted">Total Expense</div>
                <div class="h3 mb-0">₹{{ total_expense }}</div>
              </div>
              <div class="text-end">
                <div class="small-muted">Entries</div>
                <div class="fw-semibold">{{ expenses|length }}</div>
              </div>
            </div>
          </div>
        </div>
        

        <!-- Budget Card -->
        <div class="col-md-4">
          {% if budget %}
            <div class="card shadow-sm p-3 {% if remaining < 0 %}card-warning{% else %}card-budget{% endif %}">
              <div>
                <div class="small-muted">Monthly Budget</div>
                <div class="h4 mb-1">₹{{ budget.amount }}</div>
                <div class="small">
                  Remaining: <strong>₹{{ remaining }}</strong>
                </div>
                {% if remaining < 0 %}
                  <div class="mt-1 fw-semibold">⚠ Budget Exceeded</div>
                {% endif %}
              </div>
            </div>
          {% else %}
            <div class="card shadow-sm p-3 text-center">
              <div class="small-muted mb-2">No budget set for this month</div>
              <a href="{% url 'set_budget' %}" class="btn btn-sm btn-outline-success">
                Set Monthly Budget
              </a>
            </div>
          {% endif %}
        </div>

        <!-- Update Budget Button -->
        <div class="col-md-4">
          <div class="card shadow-sm p-3 text-center">
            <div class="small-muted mb-2">Manage Budget</div>
            <a href="{% url 'set_budget' %}" class="btn btn-sm btn-outline-primary">
              Set / Update Budget
            </a>
          </div>
        </div>

      <div class="card shadow-sm p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Recent Expenses</h5>
          <form method="get" class="d-flex" style="gap:.5rem">
            <input name="q" class="form-control form-control-sm" placeholder="Search title or category">
            <button class="btn btn-sm btn-outline-secondary">Filter</button>
          </form>
        </div>

        
      </div>

      </div>
      <div class="table-wrap">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Title</th>
                <th>Category</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for e in expenses %}
                <tr>
                  <td>{{ e.title }}</td>
                  <td><span class="badge bg-secondary">{{ e.category.name }}</span></td>
                  <td class="text-success fw-semibold">₹{{ e.amount }}</td>
                  <td class="small-muted">{{ e.date }}</td>
                  <td>
                    <a class="btn btn-sm btn-outline-primary me-1"
                       href="{% url 'edit_expense' e.id %}">Edit</a>
                    <a class="btn btn-sm btn-outline-danger"
                       href="{% url 'delete_expense' e.id %}"
                       onclick="return confirm('Are you sure you want to delete this expense?');">
                       Delete
                    </a>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="5" class="text-center small-muted">
                    No expenses yet. Add your first expense.
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
                    <!-- TOP CATEGORIES SUMMARY -->
      {% if top_categories %}
        <div class="row g-3 mb-4">
          <div class="col-12">
            <h6 class="fw-bold mb-3">Top Spending Categories</h6>
          </div>
          {% for category in top_categories %}
            <div class="col-md-4">
              <div class="card card-category shadow-sm p-3">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <div class="small-muted">{{ category.name }}</div>
                    <div class="h5 mb-0">₹{{ category.amount|floatformat:2 }}</div>
                  </div>
                  <div class="text-end">
                    <div class="small-muted">Percentage</div>
                    <div class="fw-semibold">{{ category.percentage }}%</div>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <!-- CHARTS & SUMMARY SECTION -->
      <div class="row g-3 mb-4">
        
        <!-- Category Breakdown Chart -->
        <div class="col-lg-6">
          <div class="chart-wrapper">
            <h6 class="mb-3 fw-bold">Expenses by Category</h6>
            {% if category_amounts|length > 0 %}
              <div class="chart-container">
                <canvas id="categoryChart"></canvas>
              </div>
            {% else %}
              <div class="text-center text-muted py-5">
                <p>No expenses yet. Add your first expense to see the breakdown.</p>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Monthly Trend Chart -->
        <div class="col-lg-6">
          <div class="chart-wrapper">
            <h6 class="mb-3 fw-bold">12-Month Spending Trend</h6>
            {% if monthly_amounts|length > 0 %}
              <div class="chart-container">
                <canvas id="monthlyChart"></canvas>
              </div>
            {% else %}
              <div class="text-center text-muted py-5">
                <p>No spending data available.</p>
              </div>
            {% endif %}
          </div>
        </div>

      </div>



    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      /* eslint-disable */
      // Category Pie Chart
      {% if category_amounts|length > 0 %}
        const categoryCtx = document.getElementById('categoryChart').getContext('2d');
        const categoryChart = new Chart(categoryCtx, {
          type: 'doughnut',
          data: {
            labels: {{ category_labels|safe }},
            datasets: [{
              data: {{ category_amounts|safe }},
              backgroundColor: [
                '#4f46e5', '#06b6d4', '#f59e0b', '#ef4444', '#8b5cf6',
                '#ec4899', '#14b8a6', '#f97316', '#6366f1', '#10b981'
              ],
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: { padding: 15, font: { size: 12 } }
              }
            }
          }
        });
      {% endif %}

      // Monthly Trend Line Chart
      {% if monthly_amounts|length > 0 %}
        const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
        const monthlyChart = new Chart(monthlyCtx, {
          type: 'line',
          data: {
            labels: {{ monthly_labels|safe }},
            datasets: [{
              label: 'Monthly Spending (₹)',
              data: {{ monthly_amounts|safe }},
              borderColor: '#4f46e5',
              backgroundColor: 'rgba(79, 70, 229, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointRadius: 5,
              pointBackgroundColor: '#4f46e5',
              pointBorderColor: '#fff',
              pointBorderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                labels: { font: { size: 12 } }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { callback: function(value) { return '₹' + value; } }
              }
            }
          }
        });
      {% endif %}
      /* eslint-enable */
    </script>
  </body>
</html>
